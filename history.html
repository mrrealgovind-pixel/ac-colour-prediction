<!DOCTYPE html>
<html>
<head>
  <title>History - AC Colour Prediction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { background:#111;color:#fff;font-family:Arial;padding:10px; }
    h2 { text-align:center;margin-bottom:20px; }

    .sectionTitle {
      font-size:20px;
      font-weight:bold;
      margin-top:25px;
      margin-bottom:10px;
      padding-bottom:5px;
      border-bottom:2px solid #0af;
    }

    .card {
      background:#222;padding:10px;margin:8px 0;border-radius:8px;
      border-left:5px solid #0af;
    }

    .green { border-left-color:#00e676; }
    .red { border-left-color:#ff5252; }
    .orange { border-left-color:#ffab00; }
    .blue { border-left-color:#2979ff; }
  </style>
</head>
<body>

<h2>Transaction History</h2>

<div class="sectionTitle">ðŸŽ® Game Result History</div>
<div id="gameHistory">Loading...</div>

<div class="sectionTitle">ðŸ’° Recharge History</div>
<div id="rechargeHistory">Loading...</div>

<div class="sectionTitle">ðŸ’¸ Withdrawal History</div>
<div id="withdrawHistory">Loading...</div>

<script>
/* ---------- FIREBASE ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- AUTH CHECK ---------- */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
  } else {
    loadAllHistory(user.uid);
  }
});

/* ---------- LOAD ALL HISTORY ---------- */
function loadAllHistory(uid){

  db.collection("transactions")
    .where("uid", "==", uid)
    .orderBy("time", "desc")
    .onSnapshot(snap=>{

      let gameHTML = "";
      let rechargeHTML = "";
      let withdrawHTML = "";

      if(snap.empty){
        document.getElementById("gameHistory").innerHTML = "<p>No Game Data</p>";
        document.getElementById("rechargeHistory").innerHTML = "<p>No Recharge Data</p>";
        document.getElementById("withdrawHistory").innerHTML = "<p>No Withdrawal Data</p>";
        return;
      }

      snap.forEach(doc=>{
        const t = doc.data();

        // Safe time handling
        let finalTime = t.time || t.requestedAt || null;
        let showTime = finalTime ? finalTime.toDate().toLocaleString() : "â€”";

        if(t.type === "Win" || t.type === "Lose" || t.type.includes("Game")){
          let cls = t.type === "Win" ? "green" : "red";
          gameHTML += `
            <div class="card ${cls}">
              <b>${t.type}</b><br>
              Coins: <b>${t.coins}</b><br>
              <small>${showTime}</small>
            </div>`;
        }

        else if(t.type === "Recharge"){
          let cls = t.status === "Approved" ? "green" : t.status === "Rejected" ? "red" : "orange";
          rechargeHTML += `
            <div class="card ${cls}">
              <b>Recharge: ${t.status}</b><br>
              Coins: <b>${t.coins}</b><br>
              <small>${showTime}</small>
            </div>`;
        }

        else if(t.type === "Withdrawal"){
          let cls = t.status === "Approved" ? "green" : t.status === "Rejected" ? "red" : "orange";
          withdrawHTML += `
            <div class="card ${cls}">
              <b>Withdrawal: ${t.status}</b><br>
              Coins: <b>${t.coins}</b><br>
              <small>${showTime}</small>
            </div>`;
        }

      });

      document.getElementById("gameHistory").innerHTML = gameHTML || "<p>No Game Data</p>";
      document.getElementById("rechargeHistory").innerHTML = rechargeHTML || "<p>No Recharge Data</p>";
      document.getElementById("withdrawHistory").innerHTML = withdrawHTML || "<p>No Withdrawal Data</p>";

    });
}
</script>

</body>
</html>
