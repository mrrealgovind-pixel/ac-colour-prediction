<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Withdrawals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body{font-family:Arial;background:#111;color:#fff;text-align:center;padding:15px;}
    table{width:100%;border-collapse:collapse;margin-top:15px;}
    th,td{border:1px solid #555;padding:8px;text-align:center;}
    th{background:#222;}
    button{padding:6px 12px;margin:3px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;}
    .approve{background:#00ff00;color:#000;}
    .reject{background:#ff5252;color:#fff;}
  </style>
</head>
<body>

<h2>Pending Withdrawals</h2>
<table id="withdrawTable">
<tr>
  <th>User</th>
  <th>Coins</th>
  <th>UPI/Bank</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Check Admin Login (optional: simple email check)
auth.onAuthStateChanged(async u=>{
  if(!u) location.href="index.html";
  // load withdrawals
  loadWithdrawals();
});

async function loadWithdrawals(){
  const snap = await db.collection("withdrawals").where("status","==","Pending").orderBy("requestedAt","desc").get();
  const table = document.getElementById("withdrawTable");
  snap.forEach(doc=>{
    const d = doc.data();
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = d.email;
    row.insertCell(1).innerText = d.coins;
    row.insertCell(2).innerText = d.upi || d.bank || "";
    row.insertCell(3).innerText = d.status;

    const actionCell = row.insertCell(4);
    const approveBtn = document.createElement("button");
    approveBtn.innerText = "Approve";
    approveBtn.className="approve";
    approveBtn.onclick = ()=>handleWithdrawal(doc.id,true,d);
    const rejectBtn = document.createElement("button");
    rejectBtn.innerText = "Reject";
    rejectBtn.className="reject";
    rejectBtn.onclick = ()=>handleWithdrawal(doc.id,false,d);

    actionCell.appendChild(approveBtn);
    actionCell.appendChild(rejectBtn);
  });
}

async function handleWithdrawal(id, approve, data){
  const uRef = db.collection("users").doc(data.uid);
  const tRef = db.collection("transactions");

  if(approve){
    // Approve: coins already deducted in wallet
    await db.collection("withdrawals").doc(id).update({status:"Approved"});
    // Update transaction
    await tRef.add({
      uid: data.uid,
      type: "Withdrawal",
      coins: data.coins,
      status: "Approved",
      time: new Date()
    });
    alert("✅ Withdrawal Approved");
  } else {
    // Reject: coins back to user
    await db.collection("withdrawals").doc(id).update({status:"Rejected"});
    await uRef.update({coins: firebase.firestore.FieldValue.increment(data.coins)});
    await tRef.add({
      uid: data.uid,
      type: "Withdrawal",
      coins: data.coins,
      status: "Rejected",
      time: new Date()
    });
    alert("❌ Withdrawal Rejected & Coins Refunded");
  }

  // Reload table
  document.getElementById("withdrawTable").innerHTML = `
  <tr>
    <th>User</th>
    <th>Coins</th>
    <th>UPI/Bank</th>
    <th>Status</th>
    <th>Action</th>
  </tr>`;
  loadWithdrawals();
}
</script>

</body>
</html>
