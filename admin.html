<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - AC Colour Prediction (PRO)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body{background:#111;color:#fff;font-family:Arial;padding:10px;}
    h2,h3{text-align:center;}
    button,select,input{padding:8px;margin:5px;font-weight:bold;border-radius:6px;border:none;cursor:pointer;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #555;padding:6px;text-align:center;}
    .approve{background:#00e676;color:#000;}
    .reject{background:#ff5252;color:#fff;}
    input[type=text]{width:150px;color:#000;}
  </style>
</head>
<body>
<h2>ADMIN PANEL (PRO)</h2>
<hr>

<h3>ðŸ’° Recharge Requests (UTR SYSTEM)</h3>
<p>Admin UPI ID:
<input type="text" id="adminUpi" placeholder="Enter UPI ID">
<button onclick="updateAdminUpi()">Update</button></p>

<table id="rechargeTable">
<tr>
<th>User</th>
<th>Amount</th>
<th>UTR Number</th>
<th>Status</th>
<th>Action</th>
</tr>
</table>

<hr>
<button onclick="logout()">Logout</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "admin@gmail.com";

auth.onAuthStateChanged(user=>{
  if(!user || user.email !== ADMIN_EMAIL){
    alert("Not Authorized");
    location.href = "index.html";
  } else {
    loadRechargeRequests();
    loadAdminUpi();
  }
});

function loadRechargeRequests(){
  db.collection("walletRequests")
    .orderBy("time","desc")
    .onSnapshot(snap=>{
      let html = `<tr>
      <th>User</th>
      <th>Amount</th>
      <th>UTR Number</th>
      <th>Status</th>
      <th>Action</th>
      </tr>`;
      snap.forEach(doc=>{
        const d = doc.data();
        html += `<tr>
        <td>${d.email}</td>
        <td>${d.amount}</td>
        <td>${d.utr || "-"}</td>
        <td>${d.status || "Pending"}</td>
        <td>${
          d.status==="Approved" || d.status==="Rejected"
          ? "-"
          : `<button class="approve" onclick="approveRecharge('${doc.id}',${d.amount},'${d.uid}')">Approve</button>
             <button class="reject" onclick="rejectRecharge('${doc.id}')">Reject</button>`
        }</td>
        </tr>`;
      });
      rechargeTable.innerHTML = html;
  });
}

async function approveRecharge(id, amount, uid){
  const ref = db.collection("users").doc(uid);
  await ref.update({
    coins: firebase.firestore.FieldValue.increment(Number(amount))
  });
  await db.collection("walletRequests").doc(id).update({status:"Approved"});
  alert("Recharge Approved!");
}

async function rejectRecharge(id){
  await db.collection("walletRequests").doc(id).update({status:"Rejected"});
  alert("Recharge Rejected!");
}

async function loadAdminUpi(){
  const doc = await db.collection("admin").doc("upi").get();
  if(doc.exists){ adminUpi.value = doc.data().upi; }
}

async function updateAdminUpi(){
  const upi = adminUpi.value.trim();
  if(!upi) return alert("Enter valid UPI ID");
  await db.collection("admin").doc("upi").set({upi});
  alert("UPI Updated");
}

function logout(){ auth.signOut(); }
</script>
</body>
  </html>
