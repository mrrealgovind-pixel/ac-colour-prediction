<!-- Firebase SDK + Messaging -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
  storageBucket: "ac-colour-prediction.appspot.com",
  messagingSenderId: "471938348888",
  appId: "1:471938348888:web:ac3fc3eb1939eb7cbe172d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

let coins = 0;

// -------------------- INIT FCM --------------------
async function initFCM(userId){
  try{
    await Notification.requestPermission();
    const token = await messaging.getToken({ vapidKey: 'YOUR_PUBLIC_VAPID_KEY' });
    if(token) db.collection("users").doc(userId).update({fcmToken: token});
    console.log("FCM Token:", token);
  }catch(e){ console.log("FCM Error:", e); }
}

// -------------------- AUTO LOGIN --------------------
auth.onAuthStateChanged(async (u)=>{
  if(!u) location.href="index.html";

  const userRef = db.collection("users").doc(u.uid);
  const docSnap = await userRef.get();
  if(!docSnap.exists){
    await userRef.set({
      email: u.email,
      coins: 1000,
      upi:"",
      bank:"",
      account:"",
      ifsc:"",
      createdAt: new Date()
    });
  }

  coins = (await userRef.get()).data().coins || 0;
  document.getElementById("coins").innerText = coins;

  // Init push notifications
  initFCM(u.uid);
});

// -------------------- LISTEN ADMIN ROUND RESULTS --------------------
db.collection("admin").doc("result").onSnapshot(doc=>{
  if(doc.exists){
    const color = doc.data().color;
    new Notification("New Round Result", {body:"Result is: "+color});
  }
});

// -------------------- LISTEN WITHDRAWAL APPROVAL --------------------
auth.onAuthStateChanged(u=>{
  if(u){
    db.collection("withdrawals").where("uid","==",u.uid)
      .where("status","==","Approved")
      .onSnapshot(snap=>{
        snap.forEach(doc=>{
          new Notification("Withdrawal Approved", {body:doc.data().coins+" coins approved!"});
        });
      });
  }
});
</script>
