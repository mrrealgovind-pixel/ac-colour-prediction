<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
  storageBucket: "ac-colour-prediction.appspot.com",
  messagingSenderId: "471938348888",
  appId: "1:471938348888:web:ac3fc3eb1939eb7cbe172d"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let coins = 0;
let pick = "";
let time = 30;

/* -------------------- AUTO LOGIN + CREATE USER -------------------- */
auth.onAuthStateChanged(async (u) => {
  if (!u) { location.href="index.html"; return; }

  const userRef = db.collection("users").doc(u.uid);
  const docSnap = await userRef.get();

  if (!docSnap.exists) {
    await userRef.set({
     	email: u.email,
      	coins: 1000,
      	createdAt: new Date()
    });
  }

  const data = (await userRef.get()).data();
  coins = data.coins || 0;
  document.getElementById("coins").innerText = coins;
});

/* -------------------- BET -------------------- */
function bet(color) {
  pick = color;
  msg.innerText = "Selected: " + color;
}

/* -------------------- TIMER -------------------- */
setInterval(() => {
  time--;
  document.getElementById("bar").style.width = (time/30*100) + "%";
  if(time <= 0){ result(); time = 30; }
}, 1000);

/* -------------------- RESULT -------------------- */
async function result(){
  const adminDoc = await db.collection("admin").doc("result").get();
  const winColor = adminDoc.exists ? adminDoc.data().color : ["Red","Green","Violet"][Math.floor(Math.random()*3)];

  const betAmt = parseInt(betAmount.value);
  let change = 0;
  let status = "";

  if(pick === winColor){
    change = betAmt * 2;
    coins += change;
    winSound.play();
    status = "WIN";
    msg.innerText = "ðŸŽ‰ WIN â€” " + winColor;
  }else{
    change = -betAmt;
    coins -= betAmt;
    loseSound.play();
    status = "LOSE";
    msg.innerText = "âŒ LOSE â€” " + winColor;
  }

  coins = Math.max(coins,0);
  document.getElementById("coins").innerText = coins;

  const u = auth.currentUser;
  if(u){
    db.collection("users").doc(u.uid).update({coins});

    // âœ… SAVE TRANSACTION HISTORY
    db.collection("transactions").add({
      uid: u.uid,
      type: status,
      amount: change,
      bet: betAmt,
      color: winColor,
      pick: pick,
      time: new Date()
    });
  }

  db.collection("rounds").add({result:winColor,time:new Date()});
  loadHistory();
  pick = "";
}

/* -------------------- LOAD HISTORY -------------------- */
async function loadHistory(){
  const snap = await db.collection("rounds").orderBy("time","desc").limit(10).get();
  const historyEl = document.getElementById("history");
  historyEl.innerHTML = "";
  snap.forEach(doc=>{
    const c = doc.data().result;
    const div = document.createElement("div");
    div.className = `bubble ${c.toLowerCase()}`;
    div.innerText = c[0];
    historyEl.appendChild(div);
  });
}
loadHistory();

/* -------------------- LOGOUT -------------------- */
function logout(){
  auth.signOut().then(()=>location.href="index.html");
}
  </script>
