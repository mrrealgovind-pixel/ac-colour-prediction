<!DOCTYPE html>
<html>
<head>
<title>Wallet - AC Colour Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
    font-family: Arial;
    background:#0f0f0f;
    color:#fff;
    padding:10px;
}
.card{
    background:#1a1a1a;
    padding:15px;
    border-radius:10px;
    margin:10px 0;
}
button{
    background:#00d46e;
    padding:10px;
    border:none;
    border-radius:6px;
    color:#000;
    font-weight:bold;
    margin-top:10px;
    width:100%;
}
input{
    width:100%;
    padding:10px;
    margin-top:5px;
    border:none;
    border-radius:6px;
}
.history-item{
    background:#222;
    padding:10px;
    margin:5px 0;
    border-radius:6px;
}
</style>

</head>

<body>

<h2>ðŸ’° My Wallet</h2>

<div class="card">
    <h3>Available Coins: <span id="coins">0</span></h3>
</div>

<!-- ADD COINS -->
<div class="card">
    <h3>Add Coins</h3>
    <input id="addCoinsAmount" type="number" placeholder="Enter Coins">
    <button onclick="openRecharge()">Proceed to Recharge</button>
</div>

<!-- WITHDRAW COINS -->
<div class="card">
    <h3>Withdraw Coins</h3>
    <input id="withdrawAmount" type="number" placeholder="Enter Withdraw Coins">
    <button onclick="withdrawCoins()">Request Withdrawal</button>
</div>

<!-- TRANSACTION HISTORY -->
<div class="card">
    <h3>Withdrawal History</h3>
    <div id="history"></div>
</div>

<button onclick="logout()" style="background:red;color:white;">Logout</button>

<script>
/* ---------------- Firebase Config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let UID = "";

/* ---------------- Auth Check ---------------- */
auth.onAuthStateChanged(user=>{
    if(!user){
        location.href = "index.html";
    } else {
        UID = user.uid;
        loadUserCoins();
        loadHistory();
    }
});

/* ---------------- Load Coins ---------------- */
function loadUserCoins(){
    db.collection("users").doc(UID).onSnapshot(doc=>{
        if(doc.exists){
            document.getElementById("coins").innerText = doc.data().coins || 0;
        }
    });
}

/* ---------------- Recharge Redirect ---------------- */
function openRecharge(){
    let amount = document.getElementById("addCoinsAmount").value;

    if(amount <= 0 || amount === ""){
        alert("Enter valid amount");
        return;
    }

    // Redirect to recharge page with amount
    window.location.href = "recharge.html?amount=" + amount;
}

/* ---------------- Withdraw Coins ---------------- */
async function withdrawCoins(){
    let amount = parseInt(document.getElementById("withdrawAmount").value);

    if(amount <= 0){
        alert("Enter valid withdrawal amount");
        return;
    }

    const userDoc = await db.collection("users").doc(UID).get();

    if(!userDoc.exists) return;

    let coins = userDoc.data().coins || 0;

    if(amount > coins){
        alert("Not enough coins");
        return;
    }

    await db.collection("withdrawals").add({
        uid: UID,
        email: userDoc.data().email,
        coins: amount,
        upi: userDoc.data().upi || "-",
        status: "Pending",
        requestedAt: new Date()
    });

    alert("Withdrawal Request Submitted!");
    document.getElementById("withdrawAmount").value = "";
}

/* ---------------- History ---------------- */
function loadHistory(){
    db.collection("withdrawals")
      .where("uid","==",UID)
      .orderBy("requestedAt","desc")
      .onSnapshot(snap=>{
          let html = "";

          snap.forEach(doc=>{
              const d = doc.data();
              html += `
              <div class="history-item">
                <b>${d.coins} Coins</b><br>
                Status: ${d.status}<br>
                <small>${d.requestedAt.toDate().toLocaleString()}</small>
              </div>`;
          });

          document.getElementById("history").innerHTML = html;
      });
}

/* ---------------- Logout ---------------- */
function logout(){
    auth.signOut().then(()=>{
        location.href = "index.html";
    });
}
</script>

</body>
</html>
