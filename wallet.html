<!DOCTYPE html>
<html>
<head>
<title>Wallet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
    background:#0d0d0d;
    color:#fff;
    font-family:Arial;
    padding:15px;
}
.card{
    background:#1a1a1a;
    padding:15px;
    margin-top:15px;
    border-radius:10px;
}
button{
    width:100%;
    padding:12px;
    background:#00e676;
    color:#000;
    border:none;
    font-weight:bold;
    border-radius:8px;
    margin-top:10px;
}
input{
    width:100%;
    padding:10px;
    margin-top:10px;
    background:#222;
    color:#fff;
    border:none;
    border-radius:6px;
}
.historyBox{
    background:#111;
    padding:10px;
    border-radius:8px;
    margin-top:8px;
    border:1px solid #333;
}
</style>

</head>

<body>

<h2>ðŸ’¼ My Wallet</h2>

<div class="card">
    <h3>Available Coins: <span id="coins">0</span></h3>
</div>

<!-- Add Coins -->
<div class="card">
    <h3>âœ¨ Add Coins</h3>
    <input type="number" id="addAmount" placeholder="Enter amount">
    <button onclick="proceedRecharge()">Proceed to Recharge</button>
</div>

<!-- Withdraw Coins -->
<div class="card">
    <h3>ðŸ’¸ Withdraw Coins</h3>
    <input type="number" id="withdrawAmount" placeholder="Enter amount">
    <button onclick="withdrawCoins()">Withdraw</button>
</div>

<!-- Recharge History -->
<div class="card">
    <h3>ðŸ§¾ Recharge History</h3>
    <div id="rechHistory"></div>
</div>

<!-- Withdrawal History -->
<div class="card">
    <h3>ðŸ“¤ Withdrawal History</h3>
    <div id="wdHistory"></div>
</div>

<script>
/* ------ Firebase Config ------ */
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let UID = "";

/* ------ AUTH ------ */
auth.onAuthStateChanged(user=>{
    if(!user) location.href="index.html";
    UID = user.uid;
    loadCoins();
    loadRechargeHistory();
    loadWithdrawalHistory();
});

/* ------ Load Coins ------ */
function loadCoins(){
    db.collection("users").doc(UID).onSnapshot(doc=>{
        document.getElementById("coins").innerText = doc.data().coins || 0;
    });
}

/* ------ Proceed Recharge ------ */
function proceedRecharge(){
    let amount = document.getElementById("addAmount").value;

    if(amount < 50){
        alert("Minimum recharge is 50.");
        return;
    }

    window.location.href = "recharge.html?amount=" + amount;  
}

/* ------ Withdraw Coins ------ */
async function withdrawCoins(){
    let amount = Number(document.getElementById("withdrawAmount").value);

    if(amount < 100){
        alert("Minimum withdrawal 100 coins");
        return;
    }

    let userDoc = await db.collection("users").doc(UID).get();
    let balance = userDoc.data().coins;

    if(balance < amount){
        alert("Insufficient balance");
        return;
    }

    await db.collection("withdrawals").add({
        uid: UID,
        coins: amount,
        email: userDoc.data().email,
        upi: userDoc.data().upi || "",
        status: "Pending",
        requestedAt: new Date()
    });

    alert("Withdrawal request submitted!");
}

/* ------ Recharge History ------ */
function loadRechargeHistory(){
    db.collection("rechargeRequests")
      .where("uid","==",UID)
      .orderBy("time","desc")
      .onSnapshot(snap=>{
        
        let html = "";
        snap.forEach(doc=>{
            let d = doc.data();
            html += `
                <div class="historyBox">
                    <b>Amount:</b> ${d.amount} Coins<br>
                    <b>Status:</b> ${d.status}<br>
                    <b>Date:</b> ${d.time.toDate().toLocaleString()}
                </div>
            `;
        });

        document.getElementById("rechHistory").innerHTML = html;
    });
}

/* ------ Withdrawal History ------ */
function loadWithdrawalHistory(){
    db.collection("withdrawals")
      .where("uid","==",UID)
      .orderBy("requestedAt","desc")
      .onSnapshot(snap=>{

        let html = "";
        snap.forEach(doc=>{
            let d = doc.data();
            html += `
                <div class="historyBox">
                    <b>Coins:</b> ${d.coins}<br>
                    <b>Status:</b> ${d.status}<br>
                    <b>Date:</b> ${d.requestedAt.toDate().toLocaleString()}
                </div>
            `;
        });

        document.getElementById("wdHistory").innerHTML = html;
    });
}
</script>

</body>
    </html>
