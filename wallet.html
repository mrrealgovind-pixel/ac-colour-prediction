<!DOCTYPE html>
<html>
<head>
<title>Wallet - AC Colour Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial;padding:10px;}
h2{text-align:center;}
button,input{padding:10px;border-radius:6px;border:none;margin:5px;font-weight:bold;}
.recharge{background:#00e5ff;color:#000;}
.withdraw{background:#ffca28;color:#000;}
</style>
</head>
<body>

<h2>My Wallet</h2>

<p>Coins: <span id="coins">0</span></p>

<hr>

<h3>Admin UPI ID</h3>
<p id="adminUpi" style="font-size:18px;color:#00e676;">Loading...</p>

<hr>

<h3>Add Coins</h3>
<input type="number" id="amount" placeholder="Enter Amount">
<input type="file" id="ssFile" accept="image/*">

<button class="recharge" onclick="sendRecharge()">Proceed To Recharge</button>

<hr>

<h3>Withdrawal</h3>
<input type="number" id="wAmount" placeholder="Enter Withdrawal Amount">
<button class="withdraw" onclick="withdraw()">Withdraw</button>

<hr>

<h3>Recharge History</h3>
<div id="rechHistory">Loading...</div>

<hr>

<h3>Withdrawal History</h3>
<div id="withHistory">Loading...</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
  storageBucket: "ac-colour-prediction.appspot.com"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let USER_ID = "";
let USER_EMAIL = "";

/* ================= LOGIN CHECK ================= */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login.html";
  } else {
    USER_ID = user.uid;
    USER_EMAIL = user.email;
    loadWallet();
    loadUPI();
    loadHistory();
  }
});

/* ================= LOAD LIVE COINS ================= */
function loadWallet(){
  db.collection("users").doc(USER_ID).onSnapshot(d=>{
    coins.innerText = d.data().coins || 0;
  });
}

/* ================= SHOW ADMIN UPI TO USER ================= */
function loadUPI(){
  db.collection("admin").doc("upi").onSnapshot(doc=>{
    if(doc.exists){
      adminUpi.innerHTML = doc.data().upi;
    } else {
      adminUpi.innerHTML = "Admin has not set UPI ID";
    }
  });
}

/* ================= SEND RECHARGE REQUEST ================= */
async function sendRecharge(){
  let amt = document.getElementById("amount").value;
  let file = document.getElementById("ssFile").files[0];

  if(!amt) return alert("Enter amount");
  if(!file) return alert("Upload Screenshot");

  const ref = storage.ref("rechargeSS/" + Date.now() + "_" + file.name);
  await ref.put(file);
  const url = await ref.getDownloadURL();

  await db.collection("walletRequests").add({
    uid: USER_ID,
    email: USER_EMAIL,
    amount: Number(amt),
    screenshot: url,
    time: new Date()
  });

  alert("Recharge Request Sent!");
  amount.value = "";
  ssFile.value = "";
}

/* ================= WITHDRAW ================= */
async function withdraw(){
  let amt = document.getElementById("wAmount").value;
  if(!amt) return alert("Enter amount");

  const userDoc = await db.collection("users").doc(USER_ID).get();
  let coins = userDoc.data().coins || 0;

  if(coins < amt) return alert("Not enough coins!");

  await db.collection("withdrawals").add({
    uid: USER_ID,
    email: USER_EMAIL,
    coins: Number(amt),
    requestedAt: new Date(),
    status: "Pending"
  });

  alert("Withdrawal Request Sent!");
  wAmount.value = "";
}

/* ================= HISTORY ================= */
function loadHistory(){
  
  // Recharge History
  db.collection("walletRequests")
    .where("uid","==",USER_ID)
    .orderBy("time","desc")
    .onSnapshot(s=>{
      let html = "";
      s.forEach(d=>{
        let h = d.data();
        html += `<p>Amount: ${h.amount} | <a href="${h.screenshot}" target="_blank">Screenshot</a></p>`;
      });
      rechHistory.innerHTML = html || "No records";
    });

  // Withdraw History
  db.collection("withdrawals")
    .where("uid","==",USER_ID)
    .orderBy("requestedAt","desc")
    .onSnapshot(s=>{
      let html = "";
      s.forEach(d=>{
        let w = d.data();
        html += `<p>Amount: ${w.coins} | ${w.status}</p>`;
      });
      withHistory.innerHTML = html || "No records";
    });

}

</script>

</body>
</html>
