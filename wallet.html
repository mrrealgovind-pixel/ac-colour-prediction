<!DOCTYPE html>
<html>
<head>
<title>Wallet - AC Colour Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial,sans-serif;padding:10px;}
h2{text-align:center;}
button,input{padding:10px;border-radius:6px;border:none;margin:5px;font-weight:bold;}
.recharge{background:#00e5ff;color:#000;cursor:pointer;}
.withdraw{background:#ffca28;color:#000;cursor:pointer;}
input{width:calc(100% - 24px);}
hr{border:1px solid #333;}
p{margin:5px 0;}
table{width:100%;border-collapse:collapse;margin-top:5px;}
th,td{border:1px solid #555;padding:8px;text-align:left;}
th{background:#222;}
</style>
</head>

<body>

<h2>My Wallet</h2>

<p>Coins: <span id="coins">0</span></p>
<hr>

<h3>Admin UPI ID</h3>
<p id="adminUpi" style="font-size:18px;color:#00e676;">Loading...</p>

<hr>

<h3>Add Coins</h3>
<input type="number" id="amount" placeholder="Enter Amount"><br>
<button class="recharge" onclick="startUPIPayment()">Pay Now</button>

<hr>

<h3>Withdrawal</h3>
<input type="number" id="wAmount" placeholder="Enter Withdrawal Amount">
<button class="withdraw" onclick="withdraw()">Withdraw</button>

<hr>

<h3>Recharge History</h3>
<table id="rechHistory">
<tr><th>Amount</th><th>UTR</th><th>Status</th><th>Date</th></tr>
</table>

<hr>

<h3>Withdrawal History</h3>
<table id="withHistory">
<tr><th>Amount</th><th>Status</th><th>Date</th></tr>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let USER_ID = "";
let USER_EMAIL = "";
let ADMIN_UPI = "";
let CURRENT_REQUEST_ID = "";

auth.onAuthStateChanged(user => {
  if(!user) location.href = "login.html";
  else {
    USER_ID = user.uid;
    USER_EMAIL = user.email;
    loadWallet();
    loadUPI();
    loadHistory();
  }
});

function loadWallet(){
  db.collection("users").doc(USER_ID).onSnapshot(doc => {
    coins.innerText = doc.exists && doc.data().coins ? doc.data().coins : 0;
  });
}

function loadUPI(){
  db.collection("admin").doc("upi").onSnapshot(doc => {
    ADMIN_UPI = doc.exists ? doc.data().upi : "";
    adminUpi.innerText = ADMIN_UPI || "Admin has not set UPI ID";
  });
}

// ====================== PHONEPE WORKING UPI PAYMENT ======================
async function startUPIPayment(){
  let amt = Number(amount.value);
  if(!amt) return alert("Enter Amount");
  if(!ADMIN_UPI) return alert("Admin UPI not available");

  // ADMIN_UPI example: 9876543210@ybl
  let vpa = ADMIN_UPI;

  if(!vpa.includes("@")){
    return alert("PhonePe के लिए UPI ऐसा होना चाहिए: 9876543210@ybl");
  }

  const req = await db.collection("walletRequests").add({
    uid: USER_ID,
    email: USER_EMAIL,
    amount: amt,
    utr: "",
    status: "Waiting UTR",
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  CURRENT_REQUEST_ID = req.id;

  let upiUrl =
    `upi://pay?pa=${vpa}&pn=Admin&am=${amt}&cu=INR&tn=Recharge%20${amt}`;

  window.location.href = upiUrl;

  alert("Payment successful होने के बाद UTR नंबर paste करें");

  checkStatus(req.id);
}

function checkStatus(id){
  const interval = setInterval(async ()=>{
    let doc = await db.collection("walletRequests").doc(id).get();
    if(doc.exists && doc.data().status === "Approved"){
      clearInterval(interval);
      alert("Coins Added Successfully!");
      amount.value = "";
    }
  },3000);
}

// ====================== WITHDRAW ======================
async function withdraw(){
  let amt = Number(wAmount.value);
  if(!amt) return alert("Enter amount");

  const userDoc = await db.collection("users").doc(USER_ID).get();
  let coinsVal = userDoc.exists && userDoc.data().coins ? userDoc.data().coins : 0;

  if(coinsVal < amt) return alert("Not enough coins!");

  await db.collection("withdrawals").add({
    uid: USER_ID,
    email: USER_EMAIL,
    coins: amt,
    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: "Pending"
  });

  alert("Withdrawal Request Sent!");
  wAmount.value = "";
}

// ====================== HISTORY ======================
function loadHistory(){
  db.collection("walletRequests")
    .where("uid","==",USER_ID)
    .orderBy("time","desc")
    .onSnapshot(snapshot => {
      let html = `<tr><th>Amount</th><th>UTR</th><th>Status</th><th>Date</th></tr>`;
      if(snapshot.empty) html += `<tr><td colspan="4">No records found</td></tr>`;
      snapshot.forEach(doc => {
        let d = doc.data();
        let date = d.time ? new Date(d.time.seconds*1000).toLocaleString() : "-";
        html += `<tr><td>${d.amount || 0}</td><td>${d.utr || "-"}</td><td>${d.status || "-"}</td><td>${date}</td></tr>`;
      });
      rechHistory.innerHTML = html;
    });

  db.collection("withdrawals")
    .where("uid","==",USER_ID)
    .orderBy("requestedAt","desc")
    .onSnapshot(snapshot => {
      let html = `<tr><th>Amount</th><th>Status</th><th>Date</th></tr>`;
      if(snapshot.empty) html += `<tr><td colspan="3">No records found</td></tr>`;
      snapshot.forEach(doc => {
        let d = doc.data();
        let date = d.requestedAt ? new Date(d.requestedAt.seconds*1000).toLocaleString() : "-";
        html += `<tr><td>${d.coins || 0}</td><td>${d.status || "-"}</td><td>${date}</td></tr>`;
      });
      withHistory.innerHTML = html;
    });
}
</script>

</body>
  </html>
