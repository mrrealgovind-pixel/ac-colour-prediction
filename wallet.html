<!DOCTYPE html>
<html>
<head>
<title>Wallet - AC Colour Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial,sans-serif;padding:10px;margin:0;}
h2{text-align:center;margin-bottom:15px;}
button,input{padding:10px;border-radius:6px;border:none;margin:5px 0;font-weight:bold;width:100%;}
.recharge{background:#00e5ff;color:#000;cursor:pointer;}
.withdraw{background:#ffca28;color:#000;cursor:pointer;}
input{width:calc(100% - 22px);}
hr{border:1px solid #333;margin:15px 0;}
p{margin:5px 0;font-size:16px;}
#qrCode{margin:10px auto; display:block; width:200px; height:200px; background:#fff; border-radius:8px; padding:10px;}
.banner{background:#222;color:#00e676;padding:15px;border-radius:8px;text-align:center;margin-top:10px;font-weight:bold;}
.container{max-width:480px;margin:0 auto;}
</style>
</head>
<body>

<div class="container">

<h2>My Wallet</h2>
<p>Coins: <span id="coins">0</span></p>

<hr>

<h3>Admin UPI / Mobile</h3>
<p id="adminUpi" style="font-size:18px;color:#00e676;">Loading...</p>

<hr>

<h3>Add Coins</h3>
<input type="number" id="amount" placeholder="Enter Amount"><br>
<button class="recharge" onclick="generateQR()">Generate QR</button>
<p>Scan QR with PhonePe / GooglePay / Paytm</p>
<canvas id="qrCode"></canvas>
<input type="text" id="utr" placeholder="Enter UTR Number after payment"><br>
<button class="recharge" onclick="submitUTR()">Submit UTR</button>

<hr>

<h3>Withdrawal</h3>
<input type="number" id="wAmount" placeholder="Enter Withdrawal Amount">
<button class="withdraw" onclick="withdraw()">Withdraw</button>

<hr>

<div class="banner">Yahi Suchna: Admin approval ke baad coins wallet me add honge. Pending requests ke liye wait karein.</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let USER_ID = "";
let USER_EMAIL = "";
let ADMIN_UPI = "";
let pendingRequestId = null;

// ================= LOGIN CHECK =================
auth.onAuthStateChanged(user => {
  if(!user) location.href = "login.html";
  else {
    USER_ID = user.uid;
    USER_EMAIL = user.email;
    loadWallet();
    loadUPI();
  }
});

// ================= LOAD COINS =================
function loadWallet(){
  db.collection("users").doc(USER_ID).onSnapshot(doc => {
    coins.innerText = doc.exists && doc.data().coins ? doc.data().coins : 0;
  });
}

// ================= LOAD ADMIN UPI =================
function loadUPI(){
  db.collection("admin").doc("upi").onSnapshot(doc => {
    ADMIN_UPI = doc.exists ? doc.data().upi : "";
    adminUpi.innerText = ADMIN_UPI || "Admin has not set UPI ID";
  });
}

// ================= GENERATE QR =================
async function generateQR(){
  let amt = Number(amount.value);
  if(!amt) return alert("Enter Amount");
  if(!ADMIN_UPI) return alert("Admin UPI / Mobile not available");

  // Create pending recharge request & store ID
  const docRef = await db.collection("walletRequests").add({
    uid: USER_ID,
    email: USER_EMAIL,
    amount: amt,
    utr: "",
    status: "Pending",
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  pendingRequestId = docRef.id; // Save ID locally

  // UPI URL for QR
  let upiUrl = `upi://pay?pa=${ADMIN_UPI}&pn=AC%20Colour%20Admin&am=${amt}&cu=INR&tn=Recharge%20${amt}`;

  // Generate QR
  const canvas = document.getElementById('qrCode');
  QRCode.toCanvas(canvas, upiUrl, { width: 200 }, function (error) {
    if (error) console.error(error);
  });
}

// ================= SUBMIT UTR =================
async function submitUTR(){
  let utrNum = utr.value.trim();
  let amt = Number(amount.value);
  if(!utrNum) return alert("Enter UTR Number");
  if(!amt) return alert("Enter Amount");
  if(!pendingRequestId) return alert("Please generate QR first");

  await db.collection("walletRequests").doc(pendingRequestId).update({
    utr: utrNum,
    amount: amt,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("UTR submitted. Admin will approve and coins will be added.");
  utr.value = "";
  amount.value = "";
  const canvas = document.getElementById('qrCode');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  pendingRequestId = null; // Reset after submission
}

// ================= WITHDRAW =================
async function withdraw(){
  let amt = Number(wAmount.value);
  if(!amt) return alert("Enter amount");

  const userDoc = await db.collection("users").doc(USER_ID).get();
  let coinsVal = userDoc.exists && userDoc.data().coins ? userDoc.data().coins : 0;

  if(coinsVal < amt) return alert("Not enough coins!");

  await db.collection("withdrawals").add({
    uid: USER_ID,
    email: USER_EMAIL,
    coins: amt,
    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: "Pending"
  });

  alert("Withdrawal Request Sent!");
  wAmount.value = "";
}
</script>

</body>
</html>
