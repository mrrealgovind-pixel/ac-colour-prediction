<!DOCTYPE html>
<html>
<head>
<title>Slot Machine - JILI 3-Line</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {margin:0; background:radial-gradient(circle,#000,#111,#000); font-family:Arial; color:white; text-align:center;}
h2 {margin-top:20px; color:gold; text-shadow:0 0 10px gold; font-size:30px;}
#coins,#bet {font-size:22px;margin-top:15px;font-weight:bold;color:#00ff9d;}
.bet-btns button {width:75px;padding:8px;margin:5px;border-radius:8px;border:1px solid gold;background:#222;color:gold;font-weight:bold;}
.slot-box {width:92%;margin:auto;background:linear-gradient(145deg,#1b1b1b,#0a0a0a);padding:20px;border-radius:20px;border:3px solid gold;box-shadow:0 0 25px rgba(255,215,0,0.4);margin-top:20px;}
.reels {display:flex; justify-content:space-around; flex-direction:column; gap:5px;}
.row {display:flex; justify-content:space-around; overflow:hidden; height:90px;}
.reel {
    width:90px;height:90px;background:black;border:3px solid gold;border-radius:12px;
    font-size:50px; display:flex; justify-content:center; align-items:center;
    transform: translateY(-100%); transition: transform 0.25s linear;
    filter:blur(0px);
}
.spinning {filter: blur(4px);}
.win-glow {animation:glow 1s infinite alternate;}
@keyframes glow {from{box-shadow:0 0 10px gold;} to{box-shadow:0 0 25px yellow;}}
button.spin-btn {width:180px;padding:15px;margin-top:25px;background:linear-gradient(135deg,#ffd700,#ffae00);border:none;border-radius:15px;font-size:22px;font-weight:bold;color:black; box-shadow:0 0 20px gold;}
#result {font-size:26px;margin-top:15px;font-weight:bold;}
.payout-col {margin-top:15px;font-size:20px;}
.payout-col div{margin:5px;}
</style>
</head>

<body>

<h2>üé∞ JILI SLOT MACHINE</h2>

<div id="coins">Coins: 0</div>
<div id="bet">Bet: 10</div>

<div class="bet-btns">
<button onclick="setBet(10)">10</button>
<button onclick="setBet(20)">20</button>
<button onclick="setBet(50)">50</button>
<button onclick="setBet(100)">100</button>
</div>

<div class="slot-box">
    <div class="reels">
        <div class="row">
            <div id="r1_top" class="reel">üçí</div>
            <div id="r2_top" class="reel">üçã</div>
            <div id="r3_top" class="reel">‚≠ê</div>
        </div>
        <div class="row">
            <div id="r1_mid" class="reel">üçã</div>
            <div id="r2_mid" class="reel">‚≠ê</div>
            <div id="r3_mid" class="reel">üîî</div>
        </div>
        <div class="row">
            <div id="r1_bot" class="reel">üçí</div>
            <div id="r2_bot" class="reel">üçã</div>
            <div id="r3_bot" class="reel">‚≠ê</div>
        </div>
    </div>

    <button class="spin-btn" onclick="spin()">SPIN</button>
</div>

<div class="payout-col">
    <div>Top Line Win: <span id="payout_top">0</span></div>
    <div>Mid Line Win: <span id="payout_mid">0</span></div>
    <div>Bot Line Win: <span id="payout_bot">0</span></div>
</div>

<p id="result"></p>

<audio id="winSound" src="win.mp3"></audio>
<audio id="loseSound" src="lose.mp3"></audio>
<audio id="spinSound" src="spin.mp3"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAPFM1XnrX1A4cwQPCAkZ4sTMmnwORjx0A",
  authDomain: "ac-colour-prediction.firebaseapp.com",
  projectId: "ac-colour-prediction",
  storageBucket: "ac-colour-prediction.appspot.com",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let coins=0, bet=10, uid=null;
let winRate=40, jackpotRate=5;

// ================================
//  ADMIN CONTROLLED LOGIC MODE
// ================================
auth.onAuthStateChanged(async (user)=>{
    if(!user){ location.href="index.html"; return; }
    uid=user.uid;

    const u = await db.collection("users").doc(uid).get();
    if(u.exists){
        coins = u.data().coins || 0;
        document.getElementById("coins").innerHTML="Coins:"+coins;
    }

    const ctrl = await db.collection("slotControl").doc("settings").get();
    if(ctrl.exists){
        jackpotRate = ctrl.data().jackpotRate || 5;
        const logic = ctrl.data().logicMode || "medium";

        if(logic==="high") winRate=60;
        else if(logic==="medium") winRate=40;
        else if(logic==="low") winRate=30;
    }
});

// =================================================

function setBet(amount){
    bet=amount;
    document.getElementById("bet").innerHTML="Bet:"+bet;
}

function updateCoins(){
    db.collection("users").doc(uid).update({coins});
    document.getElementById("coins").innerHTML="Coins:"+coins;
}

function startSpinAnimation(reels){
    reels.forEach(r=>{
        r.classList.add("spinning");
        r.style.transform="translateY(100%)";
    });
}

function resetSpinAnimation(reels){
    reels.forEach(r=>{
        r.style.transform="translateY(-100%)";
    });
}

// ======================
// MAIN SPIN FUNCTION
// ======================
async function spin(){
    if(coins<bet){ alert("Not enough coins!"); return; }

    coins-=bet;
    updateCoins();

    document.getElementById("spinSound").currentTime=0;
    document.getElementById("spinSound").play();

    const top=[r1_top,r2_top,r3_top];
    const mid=[r1_mid,r2_mid,r3_mid];
    const bot=[r1_bot,r2_bot,r3_bot];

    const allReels=[...top,...mid,...bot];
    const symbols=["üçí","üçã","‚≠ê","üîî","üçâ","7Ô∏è‚É£"];

    document.getElementById("payout_top").innerText=0;
    document.getElementById("payout_mid").innerText=0;
    document.getElementById("payout_bot").innerText=0;

    // triple spin animation
    for(let i=0;i<3;i++){
        startSpinAnimation(allReels);
        await new Promise(res=>setTimeout(res,250));
        resetSpinAnimation(allReels);
        await new Promise(res=>setTimeout(res,250));
    }

    allReels.forEach(r=>r.classList.remove("spinning"));

    // MID RANDOM
    mid.forEach(r=>{
        r.innerHTML=symbols[Math.floor(Math.random()*symbols.length)];
        r.style.transform="translateY(0)";
    });

    // ============================
    // CONTROLLED TOP & BOTTOM LINES
    // ============================

    function generateLine(){
        let random = Math.random()*100;

        if(random < jackpotRate){
            return ["7Ô∏è‚É£","7Ô∏è‚É£","7Ô∏è‚É£"];
        }
        else if(random < winRate + jackpotRate){
            let s = symbols[Math.floor(Math.random()*symbols.length)];
            return [s, s, symbols[Math.floor(Math.random()*symbols.length)]];
        }
        else{
            return [
                symbols[Math.floor(Math.random()*symbols.length)],
                symbols[Math.floor(Math.random()*symbols.length)],
                symbols[Math.floor(Math.random()*symbols.length)]
            ];
        }
    }

    const TL = generateLine();
    const BL = generateLine();

    [r1_top.innerHTML,r2_top.innerHTML,r3_top.innerHTML]=TL;
    [r1_bot.innerHTML,r2_bot.innerHTML,r3_bot.innerHTML]=BL;

    allReels.forEach(r=>r.style.transform="translateY(0)");

    setTimeout(()=>{
        let lines={top, mid, bot};
        let win=0;
        let message="‚ùå Try Again!";

        for(let key in lines){
            let L = lines[key];
            let w = 0;

            if(L[0].innerHTML===L[1].innerHTML && L[1].innerHTML===L[2].innerHTML){

                if(key==="top") w=bet*10;
                if(key==="mid") w=bet*4;
                if(key==="bot") w=bet*3;

                win=w;
                message="‚ú® Win +"+w;
                L.forEach(r=>r.classList.add("win-glow"));
                winSound.play();
            }

            document.getElementById("payout_"+key).innerText=w;
        }

        coins+=win;
        updateCoins();
        result.innerText=message;

        db.collection("transactions").add({
            uid, game:"slot", bet, win,
            top:TL, mid:mid.map(r=>r.innerHTML), bot:BL,
            time:new Date()
        });

        setTimeout(()=>allReels.forEach(r=>r.classList.remove("win-glow")),1000);

    },600);
}
</script>

</body>
</html>
